name: Test
on:
  push:
    branches: [main]  # Run on push to main branch
  pull_request:       # Trigger on PRs (from fork or same repo)
  workflow_dispatch:  # Allow manual triggering


jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install project dev dependencies
        run: uv sync --only-dev

      - name: Run unit tests
        id: runtests
        timeout-minutes: 20
        run: |
          uv run coverage run -m pytest tests --junitxml=test-execution.xml
          rc=$?
          uv run coverage xml
          echo "rc=$rc" >> $GITHUB_OUTPUT

      - name: 'Save coverage report as an Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage.xml

      - name: 'Save execution report as an Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: execution-report
          path: ./test-execution.xml

      - name: Fail if unit tests are not passing
        if: ${{ steps.runtests.outputs.rc != 0}}
        uses: actions/github-script@v6
        with:
          script: |
            core.setFailed('Unittests failed with rc = ${{ steps.runtests.outputs.rc }}')

  sonarqube:
    name: SonarQube scan
    runs-on: ubuntu-latest
    needs: test
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for accurate blame and history analysis

      - name: 'Download coverage and execution report'
        uses: actions/download-artifact@v4
        with:
          pattern: '*-report'

      - name: Move downloaded reports to root
        run: |
          mv *-report/* .

      - name: Set project key
        id: project_key
        run: |
          BASE_KEY=$(grep '^sonar.projectKey=' sonar-project.properties | cut -d'=' -f2)

          if [[ -z "$BASE_KEY" ]]; then
            echo "sonar.projectKey not found in sonar-project.properties"
            exit 1
          fi

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            FINAL_KEY="$BASE_KEY"
          else
            BRANCH_NAME="${{ github.head_ref }}"
            BRANCH_KEY=$(echo "$BRANCH_NAME" | tr '/' '-' | tr -cd '[:alnum:]-')
            FINAL_KEY="${BASE_KEY}-pr-${BRANCH_KEY}"
          fi

          echo "key=$FINAL_KEY" >> "$GITHUB_OUTPUT"

      - name: SonarQube scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_GLOBAL_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ steps.project_key.outputs.key }}
            -Dsonar.qualitygate.wait=true
            -Dsonar.projectVersion=${{ github.sha }}

      - name: Comment on PR with SonarQube results (New Code Only)
        if: github.event_name == 'pull_request'
        env:
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_GLOBAL_TOKEN }}
          GH_BOT_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}
          PROJECT_KEY: ${{ steps.project_key.outputs.key }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Define new code metrics
          METRICS="new_coverage,new_lines_to_cover,new_code_smells,new_bugs,new_vulnerabilities,new_security_hotspots"

          # Fetch metrics
          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "$SONAR_HOST_URL/api/measures/component?component=$PROJECT_KEY&metricKeys=$METRICS")

          echo "Raw SonarQube API response:"
          echo "$RESPONSE" | jq .

          # Extract values or default to "N/A"
          for metric in $(echo "$METRICS" | tr ',' ' '); do
            value=$(echo "$RESPONSE" | jq -r ".component.measures[] | select(.metric==\"$metric\") | .period.value // \"N/A\"")
            eval "${metric}=\"$value\""
          done

          # Replace placeholders in the template
          COMMENT=$(sed -e "s|{{new_coverage}}|$new_coverage|" \
                        -e "s|{{new_lines_to_cover}}|$new_lines_to_cover|" \
                        -e "s|{{new_code_smells}}|$new_code_smells|" \
                        -e "s|{{new_bugs}}|$new_bugs|" \
                        -e "s|{{new_vulnerabilities}}|$new_vulnerabilities|" \
                        -e "s|{{new_security_hotspots}}|$new_security_hotspots|" \
                        -e "s|{{SONAR_HOST_URL}}|$SONAR_HOST_URL|" \
                        -e "s|{{PROJECT_KEY}}|$PROJECT_KEY|" \
                        .github/sonarqube-template.md)

          # Add to GitHub summary
          echo "$COMMENT" >> "$GITHUB_STEP_SUMMARY"

          # Post the comment to the PR
          curl -s -H "Authorization: token $GH_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              -X POST \
              -d "$(jq -nc --arg body "$COMMENT" '{body: $body}')" \
              "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"

      # Optional: Fail the job if the Quality Gate fails
      # - uses: sonarsource/sonarqube-quality-gate-action@master
      #   timeout-minutes: 5
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_GLOBAL_TOKEN }}
